Multi-Purpose Virtual Machine (Ubuntu 12.04 LTS)
------------------------------------------------

Often it is convenient to have a test server that various applications can
communicate with. For example, testing Thunderbird requires it communicate
with an smtp, pop and imap server. This documents setting up the applications
within a Precise virtual machine (details of virtilization can be found
elsewhere).


----------
Networking
----------
Setup this host with a static IP address 192.168.122.2 on network
192.168.122.0/24 (the default in kvm). These network settings are assumed
throughout this document.

Adjust /etc/network/interfaces to have:
auto eth0
iface eth0 inet static
 address 192.168.122.2
 netmask 255.255.255.0
 gateway 192.168.122.1
 dns-nameservers 192.168.122.1


-------------------
Hostname and Domain
-------------------
During install, use 'multi-precise-amd64.example.com'. This hostname is assumed
throughout this document.

Make sure /etc/hosts has:
127.0.0.1 localhost
127.0.1.1 multi-precise-amd64.example.com multi-precise-amd64

Make sure /etc/hostname has:
multi-precise-amd64


Host /etc/hosts
---------------
It is probably convenient to add to the host running this virtual machine the
following to /etc/hosts:

192.168.122.2	multi-precise-amd64.example.com multi-precise-amd64


-----
Email
-----
$ sudo apt-get install mail-stack-delivery

Setup postfix up as an 'Internet Site' with a 'System mail name' of
'multi-precise-amd64.example.com'.

Adjust /etc/postfix/main.cf have:
mydomain = example.com
mydestination = multi-precise-amd64.example.com, localhost.example.com, $mydomain, localhost

Results:
Postfix can now receive email for user@example.com
dovecot has a self-signed certificate and listens on 110, 143, 993, 995

Since this server is for testing, we want to enable plaintext logins too,
so adjust /etc/dovecot/conf.d/01-mail-stack-delivery.conf to have:
disable_plaintext_auth = no

Clients will likely need to use TLS or SSL, as by default dovecot disables
plain text auth on 110 and 143.

---------
SSL Certs
---------

*WARNING*
The self-signed certificate generated by ssl-cert only lasts one month on
Hardy. It can be regenerated with:
$ sudo make-ssl-cert generate-default-snakeoil --force-overwrite

You can also optionally do:
$ sudo cp /usr/sbin/make-ssl-cert /root

Then apply the following patch to /root/make-ssl-cert:
$ diff -Naur /usr/sbin/make-ssl-cert /root/make-ssl-cert
--- /usr/sbin/make-ssl-cert	2008-05-14 02:21:20.000000000 -0500
+++ /root/make-ssl-cert	2009-03-17 13:29:36.000000000 -0500
@@ -121,7 +121,7 @@
     cd $(dirname $output)
     ln -sf $(basename $output) $(openssl x509 -hash -noout -in $output)
 else
-    openssl req -config $TMPFILE -new -x509 -nodes \
+    openssl req -config $TMPFILE -new -x509 -nodes -days 3650 \
 	-out /etc/ssl/certs/ssl-cert-snakeoil.pem \
         -keyout /etc/ssl/private/ssl-cert-snakeoil.key > /dev/null 2>&1
     chmod 644 /etc/ssl/certs/ssl-cert-snakeoil.pem

Then do:
$ sudo /root/make-ssl-cert generate-default-snakeoil --force-overwrite
$ openssl x509 -text -in ./ssl-cert-snakeoil.pem | grep 'Not After'
            Not After : Mar 15 18:29:56 2019 GMT


NOTE:
If trying to test TLS, will need to make sure the client is resolvable in
the multipurpose VM. This is usually done by doing something like this in
/etc/hosts:
192.168.122.93  sec-precise-i386


Default Email Accounts
----------------------
When testing mail clients or encryption ibraries (like NSS), it is convenient
to have multiple email accounts on the machine that you can access in different
ways.

POP/IMAP:
sudo adduser --shell /bin/false ubuntu-pop3tls
for i in pop3tls pop3s pop3 imaptls imaps imap; do
    sudo adduser --shell /bin/false ubuntu-$i
done

Username: ubuntu-pop3tls
Password: pop3tls
Username: ubuntu-pop3
Password: pop3
Username: ubuntu-pop3s
Password: pop3s
Username: ubuntu-imaptls
Password: imaptls
Username: ubuntu-imap
Password: imap
Username: ubuntu-imaps
Password: imaps

SMTP/AUTH:
for i in smtpauth-tls smtpauth ; do
    sudo saslpasswd2 -c -u `postconf -h myhostname` ubuntu-$i
done

Username: ubuntu-smtpauth-tls
Password: smtpauth-tls
Username: ubuntu-smtpauth
Password: smtpauth

Then add the following to /etc/aliases for some convenience accounts:
ubuntu: ubuntu-pop, ubuntu-imap
ubuntu-pop: ubuntu-pop3tls, ubuntu-pop3, ubuntu-pop3s
ubuntu-imap: ubuntu-imaptls, ubuntu-imap, ubuntu-imaps

So, typically can combine these:
pop3 with smtp
pop3s with smtpauth
pop3tls with smtpauth-tls
imap with smtp
imaps with smtpauth
imaptls with smtpauth-tls


