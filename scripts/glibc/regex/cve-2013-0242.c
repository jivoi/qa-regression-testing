/* based on http://sourceware.org/git/?p=glibc.git;a=commit;h=a445af0bc722d620afed7683cd320c0e4c7c6059 */

#define _GNU_SOURCE 1
#include <stdio.h>
#include <string.h>
#include <locale.h>
#include <regex.h>

int
main (void)
{
  struct re_pattern_buffer r;
  const char *s = "\xe1\x80\x80\xe1\x80\xbb\xe1\x80\xbd\xe1\x80\x94\xe1\x80\xba\xe1\x80\xaf\xe1\x80\x95\xe1\x80\xbax";

  if (setlocale (LC_ALL, "en_US.UTF-8") == NULL)
    {
      puts ("setlocale failed");
      return 1;
    }
  memset (&r, 0, sizeof (r));

  re_compile_pattern ("[^x]x", 5, &r);
  /* This was triggering a buffer overflow.  */
  re_search (&r, s, strlen (s), 0, strlen (s), 0);
  return 0;
}

