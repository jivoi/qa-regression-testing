/*
 * $ sudo apt-get install build-essential g++ libqt4-dev
 * $ g++ -I/usr/include/qt4 -o ./CVE-2009-2700 -lQtCore -lQtNetwork -lQtTest ./CVE-2009-2700.c
 */

#include <QtTest/QtTest>
#include <QtNetwork/qsslcertificate.h>
#include <QtNetwork/qsslkey.h>
#include <QtNetwork/qsslsocket.h>
#include <assert.h>

void testNulInCN(void)
{
    QList<QSslCertificate> certList =
        QSslCertificate::fromPath("./ssl/badguy-nul-cn.crt");
    assert(certList.size() == 1);

    const QSslCertificate &cert = certList.at(0);
    assert(!cert.isNull());

    QString cn = cert.subjectInfo(QSslCertificate::CommonName);
    assert(cn != "www.bank.com");
}

void testNulInSAN(void)
{
    QList<QSslCertificate> certList =
        QSslCertificate::fromPath("./ssl/badguy-nul-san.crt");
    assert(certList.size() == 1);

    const QSslCertificate &cert = certList.at(0);
    assert(!cert.isNull());

    QMultiMap<QSsl::AlternateNameEntryType, QString> san = cert.alternateSubjectNames();
    assert(!san.isEmpty());

    QString dnssan = san.value(QSsl::DnsEntry);
    assert(!dnssan.isEmpty());
    assert(dnssan != "www.bank.com");
}

int main(void)
{
    testNulInCN();
    testNulInSAN();

    return 0;
}
