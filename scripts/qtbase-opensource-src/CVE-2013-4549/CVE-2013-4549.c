/* CVE-2013-4549.c test

   based on:
   https://qt.gitorious.org/qt/qtbase/commit/779fa9c590a1bf399b34fbf293d8399e61a1e15c

   $ sudo apt-get install build-essential g++ qtbase5-dev
   $ g++ CVE-2013-4549.c -o CVE-2013-4549 `pkg-config --cflags --libs Qt5Xml`

 */
#include <QtXml/QXmlSimpleReader>
#include <QString>
#include <assert.h>

class TestHandler : public QXmlDefaultHandler
{
public:
    TestHandler() :
        recursionCount(0)
    {
    }

    bool internalEntityDecl(const QString &name, const QString &value)
    {
        ++recursionCount;
        return QXmlDefaultHandler::internalEntityDecl(name, value);
    }

    int recursionCount;
};

void tst_QXmlSimpleReader()
{
    QFile file("2-levels-nested-dtd.xml");
    assert(file.open(QIODevice::ReadOnly));
    QXmlSimpleReader xmlReader;
    {
        QXmlInputSource *source = new QXmlInputSource(&file);
        TestHandler handler;
        xmlReader.setDeclHandler(&handler);
        xmlReader.setErrorHandler(&handler);
        assert(!xmlReader.parse(source));
    }

    file.close();
    file.setFileName("1-levels-nested-dtd.xml");
    assert(file.open(QIODevice::ReadOnly));
    {
        QXmlInputSource *source = new QXmlInputSource(&file);
        TestHandler handler;
        xmlReader.setDeclHandler(&handler);
        xmlReader.setErrorHandler(&handler);
        assert(!xmlReader.parse(source));
        // The error wasn't because of the recursion limit being reached,
        // it was because the document is not valid.
        assert(handler.recursionCount < 2);
    }

    file.close();
    file.setFileName("internal-entity-polynomial-attribute.xml");
    assert(file.open(QIODevice::ReadOnly));
    {
        QXmlInputSource *source = new QXmlInputSource(&file);
        TestHandler handler;
        xmlReader.setDeclHandler(&handler);
        xmlReader.setErrorHandler(&handler);
        assert(!xmlReader.parse(source));
        assert(handler.recursionCount == 2);
    }
}

int main(void)
{
    tst_QXmlSimpleReader();

    return 0;
}
